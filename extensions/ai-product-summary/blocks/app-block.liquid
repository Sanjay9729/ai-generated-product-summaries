{% comment %}
  AI Product Summary Block
  Displays AI-generated product title and description on product pages
{% endcomment %}

{{ 'AISummary.css' | asset_url | stylesheet_tag }}

<div id="ai-product-summary-{{ block.id }}" class="ai-product-summary-container">
  <div class="ai-summary-loading">
    <p>Loading AI-generated summary...</p>
  </div>
</div>

<script>
  (function() {
    const productId = {{ product.id | json }};
    const blockId = {{ block.id | json }};
    const shopUrl = window.location.hostname;
    const showTitle = {{ block.settings.show_title | json }};
    const showDescription = {{ block.settings.show_description | json }};

    async function fetchAISummary() {
      try {
        // Use Shopify App Proxy URL - this routes through Shopify to your app
        const apiUrl = `/apps/ai-summaries?id=gid://shopify/Product/${productId}`;

        const response = await fetch(apiUrl);

        if (!response.ok) {
          throw new Error('Failed to fetch AI summary');
        }

        const data = await response.json();

        const container = document.getElementById(`ai-product-summary-${blockId}`);

        if (data.productSummary) {
          let htmlContent = '<div class="ai-product-summary">';

          // Add title if enabled
          if (showTitle && data.enhancedTitle) {
            htmlContent += '<h3 class="ai-summary-title">' + data.enhancedTitle + '</h3>';
          }

          // Add description if enabled
          if (showDescription && data.productSummary) {
            htmlContent += '<div class="ai-summary-description"><p>' + data.productSummary + '</p></div>';
          }

          htmlContent += '</div>';

          container.innerHTML = htmlContent;
        } else {
          container.innerHTML = '';
        }
      } catch (error) {
        console.error('Error fetching AI product summary:', error);
        const container = document.getElementById(`ai-product-summary-${blockId}`);
        container.innerHTML = '';
      }
    }

    // Fetch summary when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fetchAISummary);
    } else {
      fetchAISummary();
    }
  })();
</script>

{% schema %}
{
  "name": "AI Product Summary",
  "target": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show AI Product Title",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show AI Product Description",
      "default": true
    }
  ]
}
{% endschema %}
